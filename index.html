<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>YOLOv8 TF.js Demo</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.23.0/dist/tf.min.js"></script>
<style>
  video, canvas { border: 1px solid black; }
</style>
</head>
<body>
<h2>YOLOv8 TF.js Demo</h2>
<button id="switchBtn">切换摄像头</button>
<br><br>
<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>

<script>
let model;
let video = document.getElementById('video');
let canvas = document.getElementById('canvas');
let ctx = canvas.getContext('2d');
let useFrontCamera = false; // false=后置, true=前置
let currentStream;

async function loadModel() {
  model = await tf.loadGraphModel('https://pinocchione.github.io/ios-yolo-demo/yolov8n_web_model/model.json');
  console.log('模型加载完成');
}

async function startCamera() {
  if (currentStream) {
    currentStream.getTracks().forEach(track => track.stop());
  }
  const constraints = {
    audio: false,
    video: { facingMode: useFrontCamera ? 'user' : 'environment' }
  };
  currentStream = await navigator.mediaDevices.getUserMedia(constraints);
  video.srcObject = currentStream;

  video.onloadedmetadata = () => {
    video.play();
    canvas.width = 640;
    canvas.height = 640;
    detectFrame();
  };
}

document.getElementById('switchBtn').addEventListener('click', () => {
  useFrontCamera = !useFrontCamera;
  startCamera();
});

async function detectFrame() {
  if (!model) return requestAnimationFrame(detectFrame);

  tf.engine().startScope();

  // 缩放视频到 640x640
  let input = tf.browser.fromPixels(video)
                .resizeBilinear([640, 640])
                .expandDims(0)
                .toFloat();

  // 执行推理
  const outputs = await model.executeAsync({x: input});

  // 清空画布
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // 绘制视频
  ctx.drawImage(video, 0, 0, 640, 640);

  // outputs 是模型输出，可以自己解析框信息并绘制
  // 这里简单打印一下
  console.log(outputs);

  tf.engine().endScope();
  requestAnimationFrame(detectFrame);
}

loadModel();
startCamera();
</script>
</body>
</html>
